# ═══════════════════════════════════════════════════════════════════════════════
#  CI — Standard CI + Integration CI with service containers & parallel stages
#
#  Demonstrates:
#  - Calling MULTIPLE reusable workflows from a single consumer (composition)
#  - Standard CI: lint + test + security (unchanged)
#  - Integration CI: sanity + regression (Python 3.11/3.12/3.13 matrix)
#                    + performance + Docker build/push
#  - Service containers: PostgreSQL + Redis sidecars
#  - Parallel test stages: sanity, regression, and performance run concurrently
#  - Concurrency controls (cancel-in-progress)  ← Jenkins: disableConcurrentBuilds()
#  - Path-based triggering                       ← Jenkins: changeset condition
#  - Scheduled builds (cron)                     ← Jenkins: cron trigger
#  - Parameterized builds                        ← Jenkins: parameters {} block
#
#  Jenkins equivalent would require:
#  - docker.image('postgres:16').inside {} for service containers
#  - agent { docker { image } } for container-based agents
#  - parallel { stage('Sanity') {}; stage('Regression') {}; stage('Perf') {} }
#  - docker.build/push for container image management
# ═══════════════════════════════════════════════════════════════════════════════

name: CI
on:
  push:
    branches: [main]
    # ── Path filter: only run CI when source code or config changes ──
    # Jenkins equivalent: when { changeset "src/**" }
    paths:
      - "src/**"
      - "tests/**"
      - "requirements*.txt"
      - "setup.py"
      - "Dockerfile"
      - ".github/workflows/ci.yml"
  pull_request_target:
    branches: [main]
    paths:
      - "src/**"
      - "tests/**"
      - "requirements*.txt"
      - "setup.py"
      - "Dockerfile"
      - ".github/workflows/ci.yml"
  # ── Scheduled build: nightly regression ──
  # Jenkins equivalent: triggers { cron('0 3 * * *') }
  schedule:
    - cron: "0 3 * * 1-5"   # Weekdays at 3 AM UTC
  # ── Parameterized build ──
  # Jenkins equivalent: parameters { choice(name: 'PYTHON_VERSIONS', ...) }
  workflow_dispatch:
    inputs:
      python_version:
        description: "Primary Python version"
        type: choice
        default: "3.12"
        options:
          - "3.11"
          - "3.12"
          - "3.13"
      regression_versions:
        description: "Python versions for regression matrix"
        type: choice
        default: '["3.11", "3.12", "3.13"]'
        options:
          - '["3.11", "3.12", "3.13"]'
          - '["3.12"]'
          - '["3.12", "3.13"]'
      enable_performance:
        description: "Run performance tests"
        type: boolean
        default: true
      enable_docker:
        description: "Build Docker image"
        type: boolean
        default: true

# ── Concurrency: cancel redundant runs on same branch ──
# Jenkins equivalent: properties([disableConcurrentBuilds(abortPrevious: true)])
# GHA advantage: cancel-in-progress is built-in, no plugin needed
concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write
  issues: write
  packages: write

jobs:
  # ── Standard CI (lint + test + security) ──────────────────
  ci:
    uses: mruthyunjaya-lakkappanavar/github-shared-workflows/.github/workflows/reusable-ci.yml@main
    permissions:
      contents: read
      pull-requests: write
      issues: write
    with:
      language: python
      language_version: ${{ inputs.python_version || '3.12' }}
      enable_lint: true
      enable_test: true
      enable_security_scan: true
    secrets:
      SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  # ── Integration CI (service containers + parallel stages + Docker) ──
  integration:
    uses: mruthyunjaya-lakkappanavar/github-shared-workflows/.github/workflows/reusable-integration-ci.yml@main
    permissions:
      contents: read
      pull-requests: write
      packages: write
    with:
      language: python
      language_version: ${{ inputs.python_version || '3.12' }}
      # ── Version matrix: test across Python 3.11, 3.12, 3.13 ──
      language_versions: ${{ inputs.regression_versions || '["3.11", "3.12", "3.13"]' }}
      # ── Parallel test stages ──
      enable_sanity: true
      enable_regression: true
      enable_performance: ${{ inputs.enable_performance != false }}
      # ── Docker build & push to GHCR ──
      enable_docker_build: ${{ inputs.enable_docker != false }}
      docker_image_name: "sample-app-python"
      docker_registry: "ghcr.io"
      # ── Deployment (disabled for now, enable when environments are set up) ──
      enable_deploy_staging: false
      enable_deploy_production: false
    secrets:
      SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
