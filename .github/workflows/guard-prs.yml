# Automatically close pull requests from non-collaborators
name: Guard PRs

on:
  pull_request_target:
    types: [opened]

permissions:
  pull-requests: write

jobs:
  check-contributor:
    runs-on: ubuntu-latest
    steps:
      - name: Check if PR author is a collaborator
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const author = context.payload.pull_request.user.login;

            try {
              const { data } = await github.rest.repos.checkCollaborator({
                owner,
                repo,
                username: author,
              });
              console.log(`✅ ${author} is a collaborator. PR allowed.`);
            } catch (error) {
              if (error.status === 404) {
                console.log(`❌ ${author} is NOT a collaborator. Closing PR.`);
                await github.rest.issues.createComment({
                  owner,
                  repo,
                  issue_number: context.payload.pull_request.number,
                  body: `Hi @${author}, thank you for your interest in this project.\n\nHowever, this repository only accepts contributions from explicitly added collaborators. Your pull request has been automatically closed.\n\nIf you'd like to contribute, please open an issue first to discuss your proposed changes. See [CONTRIBUTING.md](CONTRIBUTING.md) for details.`,
                });
                await github.rest.pulls.update({
                  owner,
                  repo,
                  pull_number: context.payload.pull_request.number,
                  state: 'closed',
                });
              } else {
                throw error;
              }
            }
